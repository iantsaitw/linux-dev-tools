From 4369fad215fe8fddef7d57e090794ad0c1548aaf Mon Sep 17 00:00:00 2001
From: iantsai <ian031545@gmail.com>
Date: Wed, 14 Jan 2026 16:29:21 +0800
Subject: [PATCH] EPPKE: fixed eppke MIC failure issue when is_sme_drv = 0

---
 src/pasn/pasn_initiator.c | 23 +++++++++++++++++++----
 src/pasn/pasn_responder.c |  4 ++++
 src/utils/wpa_debug.c     |  2 +-
 3 files changed, 24 insertions(+), 5 deletions(-)

diff --git a/src/pasn/pasn_initiator.c b/src/pasn/pasn_initiator.c
index 9253db943..482401586 100644
--- a/src/pasn/pasn_initiator.c
+++ b/src/pasn/pasn_initiator.c
@@ -606,9 +606,11 @@ struct wpabuf *wpas_pasn_build_auth_1(struct pasn_data *pasn,
 	u8 wrapped_data;
 	const u8 *data;
 	size_t data_len;
+	const u8 *ddata;
+	size_t ddata_len;
 	u8 *copy = NULL;
 
-	wpa_printf(MSG_DEBUG, "PASN: Building frame 1");
+	wpa_printf(MSG_DEBUG, "PASN: Building frame 1 (is_sme_drv=%d)", is_sme_drv);
 
 	if (pasn->trans_seq)
 		return NULL;
@@ -696,20 +698,24 @@ struct wpabuf *wpas_pasn_build_auth_1(struct pasn_data *pasn,
 	}
 #endif /* CONFIG_ENC_ASSOC */
 
+	wpa_hexdump_key(MSG_DEBUG, "PASN: buf", wpabuf_head(buf), wpabuf_len(buf));
+
 	if (!is_sme_drv) {
 		copy = pasn_prepend_auth_alg(pasn->auth_alg,
 					     wpabuf_head_u8(buf),
 					     wpabuf_len(buf));
+		wpa_hexdump_key(MSG_DEBUG, "PASN: copy", copy, wpabuf_len(buf) + 2);
 		if (!copy)
 			goto fail;
 		data = copy;
 		data_len = wpabuf_len(buf) + 2;
-		os_free(copy);
 	} else {
 		data = wpabuf_head_u8(buf) + IEEE80211_HDRLEN;
 		data_len = wpabuf_len(buf) - IEEE80211_HDRLEN;
 	}
 
+	wpa_hexdump_key(MSG_DEBUG, "PASN: data", data, data_len);
+
 	wpabuf_free(pasn->auth1);
 	pasn->auth1 = wpabuf_alloc_copy(data, data_len);
 
@@ -720,6 +726,7 @@ struct wpabuf *wpas_pasn_build_auth_1(struct pasn_data *pasn,
 
 	pasn->trans_seq++;
 
+	os_free(copy);
 	wpabuf_free(wrapped_data_buf);
 	wpabuf_free(pubkey);
 
@@ -748,7 +755,7 @@ struct wpabuf *wpas_pasn_build_auth_3(struct pasn_data *pasn,
 	int ret;
 	u8 hash[SHA512_MAC_LEN];
 
-	wpa_printf(MSG_DEBUG, "PASN: Building frame 3");
+	wpa_printf(MSG_DEBUG, "PASN: Building frame 3 (is_sme_drv=%d)", is_sme_drv);
 
 	if (pasn->trans_seq != WLAN_AUTH_TR_SEQ_PASN_AUTH2)
 		return NULL;
@@ -807,6 +814,8 @@ struct wpabuf *wpas_pasn_build_auth_3(struct pasn_data *pasn,
 	ptr = wpabuf_put(buf, mic_len);
 	os_memset(ptr, 0, mic_len);
 
+	wpa_printf(MSG_DEBUG, "is_sme_drv = %d", is_sme_drv);
+
 	if (!is_sme_drv) {
 		copy = pasn_prepend_auth_alg(pasn->auth_alg,
 					     wpabuf_head_u8(buf), wpabuf_len(buf));
@@ -814,12 +823,12 @@ struct wpabuf *wpas_pasn_build_auth_3(struct pasn_data *pasn,
 			goto fail;
 		data = copy;
 		data_len = wpabuf_len(buf) + 2;
-		os_free(copy);
 	} else {
 		data = wpabuf_head_u8(buf) + IEEE80211_HDRLEN;
 		data_len = wpabuf_len(buf) - IEEE80211_HDRLEN;
 	}
 
+	wpa_hexdump_key(MSG_DEBUG, "PASN: auth1", wpabuf_head(pasn->auth1), wpabuf_len(pasn->auth1));
 
 	if (!pasn->auth1 ||
 	    pasn_auth_frame_hash(pasn->hash_alg, wpabuf_head(pasn->auth1),
@@ -828,6 +837,11 @@ struct wpabuf *wpas_pasn_build_auth_3(struct pasn_data *pasn,
 		goto fail;
 	}
 
+	wpa_hexdump_key(MSG_DEBUG, "PASN: hash", hash, mic_len * 2);
+
+	wpa_printf(MSG_DEBUG, "%s: own_addr=" MACSTR " peer_addr=" MACSTR,
+			   __func__, MAC2STR(pasn->own_addr), MAC2STR(pasn->peer_addr));
+
 	ret = pasn_mic(pasn->hash_alg, pasn->ptk.kck, pasn->ptk.kck_len,
 		       pasn->own_addr, pasn->peer_addr,
 		       hash, mic_len * 2, data, data_len, mic);
@@ -847,6 +861,7 @@ struct wpabuf *wpas_pasn_build_auth_3(struct pasn_data *pasn,
 
 	pasn->trans_seq++;
 
+	os_free(copy);
 	wpa_printf(MSG_DEBUG, "PASN: frame 3: Success");
 	return buf;
 fail:
diff --git a/src/pasn/pasn_responder.c b/src/pasn/pasn_responder.c
index aebee493f..fd9c4e7f2 100644
--- a/src/pasn/pasn_responder.c
+++ b/src/pasn/pasn_responder.c
@@ -1141,12 +1141,16 @@ int handle_auth_pasn_3(struct pasn_data *pasn, const u8 *own_addr,
 	if (!copy)
 		goto fail;
 	os_memset(copy + mic_offset, 0, mic_len);
+	wpa_hexdump_key(MSG_DEBUG, "PASN: auth1", wpabuf_head(pasn->auth1), wpabuf_len(pasn->auth1));
 	if (!pasn->auth1 ||
 	    pasn_auth_frame_hash(pasn->hash_alg, wpabuf_head(pasn->auth1),
 				 wpabuf_len(pasn->auth1), hash)) {
 		wpa_printf(MSG_INFO, "PASN: Failed to calculate Auth1 hash");
 		goto fail;
 	}
+	wpa_hexdump_key(MSG_DEBUG, "PASN: hash", hash, mic_len * 2);
+	wpa_printf(MSG_DEBUG, "%s: own_addr=" MACSTR " peer_addr=" MACSTR,
+			   __func__, MAC2STR(own_addr), MAC2STR(peer_addr));
 	ret = pasn_mic(pasn->hash_alg, pasn->ptk.kck, pasn->ptk.kck_len,
 		       peer_addr, own_addr, hash, mic_len * 2,
 		       copy, copy_len, out_mic);
diff --git a/src/utils/wpa_debug.c b/src/utils/wpa_debug.c
index 0cd94a038..efcee98ec 100644
--- a/src/utils/wpa_debug.c
+++ b/src/utils/wpa_debug.c
@@ -28,7 +28,7 @@ static FILE *wpa_debug_tracing_file = NULL;
 
 
 int wpa_debug_level = MSG_INFO;
-int wpa_debug_show_keys = 0;
+int wpa_debug_show_keys = 1;
 int wpa_debug_timestamp = 0;
 int wpa_debug_syslog = 0;
 #ifndef CONFIG_NO_STDOUT_DEBUG
-- 
2.43.0

